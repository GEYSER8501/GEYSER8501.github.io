<!-- Mant√©n todo igual que antes hasta el bot√≥n Comprar Todo -->

<script>
const search=document.getElementById('search');
const products=document.querySelectorAll('.product');
const cartButton=document.getElementById('cart');
const cartPanel=document.getElementById('cartPanel');
const cartItemsContainer=document.getElementById('cartItems');
const cartTotal=document.getElementById('cartTotal');
const buyAllButton=document.getElementById('buyAll');
const cartCountEl=document.getElementById('cartCount');
const addSound=document.getElementById('addSound');

function debounce(func, wait=300){ let timeout; return function(...args){ clearTimeout(timeout); timeout=setTimeout(()=>func.apply(this,args),wait);}; }
search.addEventListener('input',debounce((e)=>{ const term=e.target.value.toLowerCase(); let visible=0; products.forEach(p=>{ if(p.dataset.name.includes(term)){p.style.display='block';visible++;}else{p.style.display='none';} }); let noResults=document.querySelector('.no-results'); if(!noResults && visible===0) document.getElementById('products').insertAdjacentHTML('beforeend','<div class="no-results">üîç No se encontraron productos con ese nombre</div>'); else if(noResults && visible>0) noResults.remove();},300));

function loadCart(){return JSON.parse(localStorage.getItem('cart'))||[];}
function saveCart(cart){localStorage.setItem('cart',JSON.stringify(cart));}

function updateCartUI(){
  const cart=loadCart();
  cartCountEl.textContent=cart.length;
  cartCountEl.style.transform='scale(1.4)';
  cartButton.classList.add('cart-shake');
  setTimeout(()=>{cartCountEl.style.transform='scale(1)'; cartButton.classList.remove('cart-shake');},300);
  cartItemsContainer.innerHTML='';
  let total=0;
  cart.forEach((item,index)=>{total+=parseFloat(item.price); const div=document.createElement('div'); div.classList.add('cart-item'); div.innerHTML=`<img src="${item.img}" alt="${item.name}"><div class="cart-item-info"><span>${item.name}</span><span>$${item.price}</span></div><button data-index="${index}">‚úñ</button>`; cartItemsContainer.appendChild(div);});
  cartTotal.textContent=`$${total.toFixed(2)}`;
  document.querySelectorAll('.cart-item button').forEach(btn=>{btn.addEventListener('click',()=>{ const idx=btn.dataset.index; const c=loadCart(); c.splice(idx,1); saveCart(c); updateCartUI(); }); });
}

function flyToCart(imgEl){
  const rect=imgEl.getBoundingClientRect();
  const flyImg=imgEl.cloneNode(true);
  flyImg.classList.add('fly-img');
  document.body.appendChild(flyImg);
  flyImg.style.left=`${rect.left}px`;
  flyImg.style.top=`${rect.top}px`;
  const cartRect=cartButton.getBoundingClientRect();
  requestAnimationFrame(()=>{ flyImg.style.transform=`translate(${cartRect.left-rect.left}px, ${cartRect.top-rect.top}px) scale(0.2)`; });
  flyImg.addEventListener('transitionend',()=>{ flyImg.remove(); });
}

function createConfetti(){
  for(let i=0;i<30;i++){
    const confetti=document.createElement('div');
    confetti.classList.add('confetti');
    confetti.style.left=Math.random()*window.innerWidth+'px';
    confetti.style.background=`hsl(${Math.random()*360},100%,50%)`;
    confetti.style.animationDuration=(Math.random()*1+0.8)+'s';
    confetti.style.transform=`rotate(${Math.random()*360}deg)`;
    document.body.appendChild(confetti);
    setTimeout(()=>confetti.remove(),1500);
  }
}

function createExplosion(x,y){
  for(let i=0;i<50;i++){
    const particle=document.createElement('div');
    particle.classList.add('confetti');
    particle.style.left=x+'px';
    particle.style.top=y+'px';
    particle.style.width=particle.style.height=Math.random()*8+4+'px';
    particle.style.background=`hsl(${Math.random()*360},100%,50%)`;
    particle.style.animationDuration=(Math.random()*1+0.8)+'s';
    const angle=Math.random()*2*Math.PI;
    const distance=Math.random()*150+50;
    particle.style.transform=`translate(${Math.cos(angle)*distance}px, ${Math.sin(angle)*distance}px) rotate(${Math.random()*360}deg)`;
    document.body.appendChild(particle);
    setTimeout(()=>particle.remove(),2000);
  }
}

function addToCart(name,price,img,imgEl){
  const cart=loadCart();
  cart.push({name,price,img});
  saveCart(cart);
  updateCartUI();
  flyToCart(imgEl);
  addSound.currentTime=0; addSound.play();
  createConfetti();
}

document.querySelectorAll('.add-cart').forEach((btn,index)=>{ btn.addEventListener('click',()=>{ const p=products[index]; addToCart(p.dataset.name,p.dataset.price,p.dataset.img,p.querySelector('img')); }); });

cartButton.addEventListener('click',()=>cartPanel.classList.toggle('open'));

buyAllButton.addEventListener('click',()=>{
  const cart=loadCart(); 
  if(cart.length===0){alert('Tu carrito est√° vac√≠o');return;}
  const cartRect=cartButton.getBoundingClientRect();
  createExplosion(cartRect.left+cartRect.width/2, cartRect.top+cartRect.height/2);
  setTimeout(()=>{
    alert(`¬°Compra simulada realizada!\nTotal: $${cart.reduce((sum,i)=>sum+parseFloat(i.price),0).toFixed(2)}`);
    localStorage.removeItem('cart'); 
    updateCartUI();
  },500);
});

updateCartUI();
</script>
